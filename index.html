<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ Feature Requests</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            background: #fff;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.2s;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #ecf0f1;
        }
        
        .panel {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 0 12px 12px 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .panel.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group.flex-1 {
            flex: 1;
        }
        
        label {
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }
        
        input, select, textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-idea { background: #e8e8e8; color: #666; }
        .status-review { background: #fff3cd; color: #856404; }
        .status-development { background: #cce5ff; color: #004085; }
        .status-done { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        
        .priority-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .priority-1 { background: #e8e8e8; color: #666; }
        .priority-2 { background: #d1ecf1; color: #0c5460; }
        .priority-3 { background: #fff3cd; color: #856404; }
        .priority-4 { background: #f8d7da; color: #721c24; }
        .priority-5 { background: #721c24; color: white; }
        
        .customer-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #3498db;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
        }
        
        .customer-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .customer-tag {
            background: #e8f4fc;
            color: #2980b9;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .customer-tag .remove {
            cursor: pointer;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .sync-info {
            color: #888;
            font-size: 13px;
            margin-bottom: 15px;
        }
        
        .api-setup {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-card.blue { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .stat-card.green { background: linear-gradient(135deg, #27ae60 0%, #219a52 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .stat-card.purple { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .top-features {
            margin-top: 30px;
        }
        
        .top-features h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .feature-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .feature-bar-name {
            width: 200px;
            font-weight: 500;
        }
        
        .feature-bar-track {
            flex: 1;
            background: #ecf0f1;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .feature-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-left: 10px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            min-width: 30px;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h2 {
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .checkbox-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        
        .checkbox-item:hover {
            background: #f8f9fa;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: -20px;
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-card h1 {
            margin-bottom: 8px;
            font-size: 28px;
        }

        .login-card p {
            color: #888;
            margin-bottom: 30px;
        }

        .login-card .form-group {
            text-align: right;
            margin-bottom: 16px;
        }

        .login-card input {
            width: 100%;
        }

        .login-card button {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            margin-top: 10px;
        }

        .login-error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 12px;
            display: none;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .clickable {
            cursor: pointer;
            color: #3498db;
        }
        
        .clickable:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <h1>ğŸ” ×”×ª×—×‘×¨×•×ª</h1>
            <p>× ×™×”×•×œ Feature Requests</p>
            <div class="form-group">
                <label>××™××™×™×œ</label>
                <input type="email" id="login-email" placeholder="×”×–×Ÿ ××™××™×™×œ">
            </div>
            <div class="form-group">
                <label>×¡×™×¡××”</label>
                <input type="password" id="login-password" placeholder="×”×–×Ÿ ×¡×™×¡××”">
            </div>
            <button class="btn-primary" id="login-btn" onclick="login()">×”×ª×—×‘×¨</button>
            <div class="login-error" id="login-error"></div>
        </div>
    </div>

    <div class="container" id="app-container" style="display:none">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>ğŸ¯ × ×™×”×•×œ Feature Requests</h1>
            <button class="btn-secondary btn-small" onclick="logout()">ğŸšª ×”×ª× ×ª×§</button>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">×“×©×‘×•×¨×“</button>
            <button class="tab" onclick="showTab('features')">×¤×™×¦'×¨×™×</button>
            <button class="tab" onclick="showTab('customers')">×œ×§×•×—×•×ª</button>
            <button class="tab" onclick="showTab('requests')">×‘×§×©×•×ª</button>
        </div>
        
        <!-- Dashboard Panel -->
        <div id="dashboard" class="panel active">
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-number" id="stat-features">0</div>
                    <div class="stat-label">×¤×™×¦'×¨×™×</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number" id="stat-customers">0</div>
                    <div class="stat-label">×œ×§×•×—×•×ª</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number" id="stat-requests">0</div>
                    <div class="stat-label">×‘×§×©×•×ª</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-number" id="stat-in-dev">0</div>
                    <div class="stat-label">×‘×¤×™×ª×•×—</div>
                </div>
            </div>
            
            <div class="top-features">
                <h3>ğŸ”¥ ×¤×™×¦'×¨×™× ××‘×•×§×©×™× ×‘×™×•×ª×¨</h3>
                <div id="top-features-chart"></div>
            </div>
        </div>
        
        <!-- Features Panel -->
        <div id="features" class="panel">
            <h2>× ×™×”×•×œ ×¤×™×¦'×¨×™×</h2>
            
            <div class="form-row">
                <div class="form-group flex-1">
                    <label>×©× ×”×¤×™×¦'×¨</label>
                    <input type="text" id="feature-name" placeholder="×©× ×”×¤×™×¦'×¨">
                </div>
                <div class="form-group">
                    <label>×¡×˜×˜×•×¡</label>
                    <select id="feature-status">
                        <option value="idea">ğŸ’¡ ×¨×¢×™×•×Ÿ</option>
                        <option value="review">ğŸ” ×‘×‘×—×™× ×”</option>
                        <option value="development">ğŸš§ ×‘×¤×™×ª×•×—</option>
                        <option value="done">âœ… ×”×•×©×œ×</option>
                        <option value="rejected">âŒ × ×“×—×”</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×§×˜×’×•×¨×™×”</label>
                    <select id="feature-category">
                        <option value="ux">UX</option>
                        <option value="integrations">××™× ×˜×’×¨×¦×™×•×ª</option>
                        <option value="reports">×“×•×—×•×ª</option>
                        <option value="automation">××•×˜×•××¦×™×”</option>
                        <option value="other">××—×¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn-success" onclick="addFeature()">â• ×”×•×¡×£ ×¤×™×¦'×¨</button>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group flex-1">
                    <label>×ª×™××•×¨</label>
                    <textarea id="feature-description" rows="2" placeholder="×ª×™××•×¨ ×”×¤×™×¦'×¨"></textarea>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>×©×</th>
                        <th>×ª×™××•×¨</th>
                        <th>×¡×˜×˜×•×¡</th>
                        <th>×§×˜×’×•×¨×™×”</th>
                        <th>×œ×§×•×—×•×ª ××‘×§×©×™×</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="features-table"></tbody>
            </table>
        </div>
        
        <!-- Customers Panel -->
        <div id="customers" class="panel">
            <h2>×œ×§×•×—×•×ª</h2>
            
            <div class="api-setup" style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <strong>×¡× ×›×¨×•×Ÿ ×œ×§×•×—×•×ª ×-Powerlink CRM</strong>
                    <div id="sync-status" style="font-size: 13px; color: #666; margin-top: 4px;"></div>
                </div>
                <button class="btn-primary" onclick="syncCustomers()" id="sync-btn">ğŸ”„ ×¡× ×›×¨×•×Ÿ ×-Powerlink</button>
            </div>
            
            <div class="sync-info" id="sync-info">×˜×¨× ×‘×•×¦×¢ ×¡× ×›×¨×•×Ÿ</div>
            
            <div class="form-row">
                <div class="form-group flex-1">
                    <label>×”×•×¡×¤×ª ×œ×§×•×— ×™×“× ×™×ª</label>
                    <input type="text" id="manual-customer-name" placeholder="×©× ×”×œ×§×•×—">
                </div>
                <div class="form-group">
                    <button class="btn-success" onclick="addManualCustomer()">â• ×”×•×¡×£</button>
                </div>
            </div>
            
            <div class="form-row" style="margin-top: 15px;">
                <div class="form-group flex-1">
                    <input type="text" id="customer-search" placeholder="ğŸ” ×—×™×¤×•×© ×œ×§×•×—..." oninput="renderCustomers()">
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>×©×</th>
                        <th>×˜×œ×¤×•×Ÿ</th>
                        <th>××™××™×™×œ</th>
                        <th>××¡' ×œ×§×•×—</th>
                        <th>××§×•×¨</th>
                        <th>×¤×™×¦'×¨×™× ××‘×•×§×©×™×</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="customers-table"></tbody>
            </table>
        </div>
        
        <!-- Requests Panel -->
        <div id="requests" class="panel">
            <h2>×§×™×©×•×¨ ×‘×§×©×•×ª</h2>
            
            <div class="form-row">
                <div class="form-group flex-1">
                    <label>×œ×§×•×—</label>
                    <select id="request-customer">
                        <option value="">×‘×—×¨ ×œ×§×•×—...</option>
                    </select>
                </div>
                <div class="form-group flex-1">
                    <label>×¤×™×¦'×¨</label>
                    <select id="request-feature">
                        <option value="">×‘×—×¨ ×¤×™×¦'×¨...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×¢×“×™×¤×•×ª</label>
                    <select id="request-priority">
                        <option value="1">1 - × ××•×›×”</option>
                        <option value="2">2</option>
                        <option value="3" selected>3 - ×‘×™× ×•× ×™×ª</option>
                        <option value="4">4</option>
                        <option value="5">5 - ×§×¨×™×˜×™×ª</option>
                    </select>
                </div>
                <div class="form-group">
                    <button class="btn-success" onclick="addRequest()">â• ×”×•×¡×£ ×‘×§×©×”</button>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group flex-1">
                    <label>×”×¢×¨×•×ª</label>
                    <input type="text" id="request-notes" placeholder="×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)">
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>×œ×§×•×—</th>
                        <th>×¤×™×¦'×¨</th>
                        <th>×¢×“×™×¤×•×ª</th>
                        <th>×ª××¨×™×š</th>
                        <th>×”×¢×¨×•×ª</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="requests-table"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Assign Customers Modal -->
    <div class="modal-overlay" id="assign-modal">
        <div class="modal">
            <h2>×©×™×•×š ×œ×§×•×—×•×ª ×œ×¤×™×¦'×¨</h2>
            <p id="assign-feature-name"></p>
            <div class="checkbox-list" id="customers-checkbox-list"></div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeAssignModal()">×‘×™×˜×•×œ</button>
                <button class="btn-primary" onclick="saveAssignments()">×©××•×¨</button>
            </div>
        </div>
    </div>

    <script>
        // ===== Google Sheets Config =====
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_wTPCy-4dC9QzehS39ZhUEgaavNkhTVQhi_jdPwVA06YEmvAbvKOdhzv6mmKtQNxAew/exec';
        const GOOGLE_CORS_PROXY = 'https://api.codetabs.com/v1/proxy?quest=';

        // Fetch from Google Apps Script with CORS proxy fallback
        async function fetchGoogleScript(url) {
            try {
                const resp = await fetch(url);
                return await resp.json();
            } catch (e) {
                console.log('Direct fetch failed, trying proxy...', e.message);
            }
            const proxyUrl = GOOGLE_CORS_PROXY + encodeURIComponent(url);
            const resp = await fetch(proxyUrl);
            return await resp.json();
        }

        // ===== Login =====
        async function login() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const btn = document.getElementById('login-btn');

            if (!email || !password) {
                errorEl.textContent = '× × ×œ××œ× ××™××™×™×œ ×•×¡×™×¡××”';
                errorEl.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = '××ª×—×‘×¨...';
            errorEl.style.display = 'none';

            try {
                const loginUrl = GOOGLE_SCRIPT_URL + '?action=login&mail=' + encodeURIComponent(email) + '&password=' + encodeURIComponent(password);
                const result = await fetchGoogleScript(loginUrl);

                if (result.success) {
                    sessionStorage.setItem('loggedInUser', email);
                    showApp();
                } else {
                    errorEl.textContent = result.error || '××™××™×™×œ ××• ×¡×™×¡××” ×©×’×•×™×™×';
                    errorEl.style.display = 'block';
                }
            } catch (e) {
                console.error('Login error:', e);
                errorEl.textContent = '×©×’×™××ª ×ª×§×©×•×¨×ª: ' + e.message;
                errorEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = '×”×ª×—×‘×¨';
            }
        }

        function logout() {
            sessionStorage.removeItem('loggedInUser');
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-password').value = '';
        }

        function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            loadData();
        }

        // Allow Enter key to submit login
        document.getElementById('login-password').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') login();
        });
        document.getElementById('login-email').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') login();
        });

        // Data
        let customersData = { lastSync: null, customers: [] };
        let featuresData = { features: [] };
        let requestsData = { requests: [] };
        let currentAssignFeatureId = null;
        
        // Status labels
        const statusLabels = {
            idea: 'ğŸ’¡ ×¨×¢×™×•×Ÿ',
            review: 'ğŸ” ×‘×‘×—×™× ×”',
            development: 'ğŸš§ ×‘×¤×™×ª×•×—',
            done: 'âœ… ×”×•×©×œ×',
            rejected: 'âŒ × ×“×—×”'
        };
        
        const categoryLabels = {
            ux: 'UX',
            integrations: '××™× ×˜×’×¨×¦×™×•×ª',
            reports: '×“×•×—×•×ª',
            automation: '××•×˜×•××¦×™×”',
            other: '××—×¨'
        };
        
        // Load data from Google Sheets (with localStorage fallback)
        async function loadData() {
            // Load from localStorage cache first for instant display
            try {
                const c = localStorage.getItem('pl_customers');
                if (c) customersData = JSON.parse(c);
                const f = localStorage.getItem('pl_features');
                if (f) featuresData = JSON.parse(f);
                const r = localStorage.getItem('pl_requests');
                if (r) requestsData = JSON.parse(r);
            } catch (e) {}
            renderAll();

            // Then sync from Google Sheets
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE') return;

            try {
                const result = await fetchGoogleScript(GOOGLE_SCRIPT_URL);
                if (result.success) {
                    customersData = {
                        lastSync: result.data.lastSync,
                        customers: result.data.customers || []
                    };
                    featuresData = { features: result.data.features || [] };
                    requestsData = { requests: result.data.requests || [] };

                    // Update localStorage cache
                    localStorage.setItem('pl_customers', JSON.stringify(customersData));
                    localStorage.setItem('pl_features', JSON.stringify(featuresData));
                    localStorage.setItem('pl_requests', JSON.stringify(requestsData));

                    renderAll();
                }
            } catch (e) {
                console.log('Google Sheets unavailable, using local cache');
            }
        }

        // Save data to Google Sheets (and localStorage cache)
        function saveData(key, data) {
            const storageKey = key.replace('.json', '');
            localStorage.setItem('pl_' + storageKey, JSON.stringify(data));

            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE') return;

            const actionMap = { customers: 'saveCustomers', features: 'saveFeatures', requests: 'saveRequests' };
            const action = actionMap[storageKey];
            if (!action) return;

            const payload = { action };
            if (storageKey === 'customers') {
                payload.data = data.customers;
                payload.lastSync = data.lastSync;
            } else if (storageKey === 'features') {
                payload.data = data.features;
            } else if (storageKey === 'requests') {
                payload.data = data.requests;
            }

            const postBody = JSON.stringify(payload);
            const postOpts = { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: postBody };
            fetch(GOOGLE_SCRIPT_URL, postOpts).catch(() => {
                fetch(GOOGLE_CORS_PROXY + encodeURIComponent(GOOGLE_SCRIPT_URL), postOpts)
                    .catch(e => console.log('Save to Google Sheets failed:', e));
            });
        }
        
        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        // Render all
        function renderAll() {
            renderDashboard();
            renderFeatures();
            renderCustomers();
            renderRequests();
            populateSelects();
        }
        
        // Dashboard
        function renderDashboard() {
            document.getElementById('stat-features').textContent = featuresData.features.length;
            document.getElementById('stat-customers').textContent = customersData.customers.length;
            document.getElementById('stat-requests').textContent = requestsData.requests.length;
            document.getElementById('stat-in-dev').textContent = 
                featuresData.features.filter(f => f.status === 'development').length;
            
            // Top features chart
            const featureRequests = featuresData.features.map(f => ({
                ...f,
                requestCount: requestsData.requests.filter(r => r.featureId === f.id).length,
                totalPriority: requestsData.requests
                    .filter(r => r.featureId === f.id)
                    .reduce((sum, r) => sum + r.priority, 0)
            })).filter(f => f.requestCount > 0)
              .sort((a, b) => b.totalPriority - a.totalPriority)
              .slice(0, 5);
            
            const maxPriority = Math.max(...featureRequests.map(f => f.totalPriority), 1);
            
            document.getElementById('top-features-chart').innerHTML = featureRequests.length ? 
                featureRequests.map(f => `
                    <div class="feature-bar">
                        <div class="feature-bar-name">${f.name}</div>
                        <div class="feature-bar-track">
                            <div class="feature-bar-fill" style="width: ${(f.totalPriority / maxPriority) * 100}%">
                                ${f.requestCount} ×œ×§×•×—×•×ª
                            </div>
                        </div>
                    </div>
                `).join('') : '<div class="no-data">××™×Ÿ ×¢×“×™×™×Ÿ ×‘×§×©×•×ª</div>';
        }
        
        // Features
        function renderFeatures() {
            const tbody = document.getElementById('features-table');
            
            if (!featuresData.features.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">××™×Ÿ ×¤×™×¦\'×¨×™×</td></tr>';
                return;
            }
            
            tbody.innerHTML = featuresData.features.map(f => {
                const requests = requestsData.requests.filter(r => r.featureId === f.id);
                const customerNames = requests.map(r => {
                    const customer = customersData.customers.find(c => c.id === r.customerId);
                    return customer ? customer.name : '×œ×§×•×— ×œ× ×™×“×•×¢';
                });
                
                return `
                    <tr>
                        <td><strong>${f.name}</strong></td>
                        <td>${f.description || '-'}</td>
                        <td><span class="status-badge status-${f.status}">${statusLabels[f.status]}</span></td>
                        <td>${categoryLabels[f.category]}</td>
                        <td>
                            <span class="customer-count clickable" onclick="openAssignModal('${f.id}')">${requests.length}</span>
                            ${customerNames.length ? `<br><small>${customerNames.slice(0, 3).join(', ')}${customerNames.length > 3 ? '...' : ''}</small>` : ''}
                        </td>
                        <td>
                            <button class="btn-primary btn-small" onclick="openAssignModal('${f.id}')">ğŸ‘¥ ×©×™×•×š</button>
                            <button class="btn-danger btn-small" onclick="deleteFeature('${f.id}')">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Customers
        function renderCustomers() {
            const tbody = document.getElementById('customers-table');
            const syncInfo = document.getElementById('sync-info');

            if (customersData.lastSync) {
                syncInfo.textContent = `×¡× ×›×¨×•×Ÿ ××—×¨×•×Ÿ: ${new Date(customersData.lastSync).toLocaleString('he-IL')} | ×¡×”"×› ${customersData.customers.length} ×œ×§×•×—×•×ª`;
            }

            if (!customersData.customers.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">××™×Ÿ ×œ×§×•×—×•×ª</td></tr>';
                return;
            }

            const searchInput = document.getElementById('customer-search');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';

            let filtered = customersData.customers;
            if (searchTerm) {
                filtered = filtered.filter(c =>
                    (c.name || '').toLowerCase().includes(searchTerm) ||
                    (c.phone || '').includes(searchTerm) ||
                    (c.email || '').toLowerCase().includes(searchTerm) ||
                    (c.accountNumber || '').includes(searchTerm)
                );
            }

            tbody.innerHTML = filtered.map(c => {
                const requestCount = requestsData.requests.filter(r => r.customerId === c.id).length;
                const sourceLabel = c.source === 'powerlink' ? 'ğŸ”— Powerlink' : c.source === 'fireberry' ? 'ğŸ”¥ Fireberry' : 'âœï¸ ×™×“× ×™';
                return `
                    <tr>
                        <td><strong>${c.name}</strong></td>
                        <td style="direction: ltr; text-align: right;">${c.phone || '-'}</td>
                        <td style="direction: ltr; text-align: right;">${c.email || '-'}</td>
                        <td>${c.accountNumber || '-'}</td>
                        <td>${sourceLabel}</td>
                        <td>${requestCount}</td>
                        <td>
                            <button class="btn-danger btn-small" onclick="deleteCustomer('${c.id}')">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Requests
        function renderRequests() {
            const tbody = document.getElementById('requests-table');
            
            if (!requestsData.requests.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">××™×Ÿ ×‘×§×©×•×ª</td></tr>';
                return;
            }
            
            tbody.innerHTML = requestsData.requests.map(r => {
                const customer = customersData.customers.find(c => c.id === r.customerId);
                const feature = featuresData.features.find(f => f.id === r.featureId);
                
                return `
                    <tr>
                        <td>${customer ? customer.name : '×œ× × ××¦×'}</td>
                        <td>${feature ? feature.name : '×œ× × ××¦×'}</td>
                        <td><span class="priority-badge priority-${r.priority}">${r.priority}</span></td>
                        <td>${new Date(r.date).toLocaleDateString('he-IL')}</td>
                        <td>${r.notes || '-'}</td>
                        <td>
                            <button class="btn-danger btn-small" onclick="deleteRequest('${r.id}')">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Populate selects
        function populateSelects() {
            const customerSelect = document.getElementById('request-customer');
            const featureSelect = document.getElementById('request-feature');
            
            customerSelect.innerHTML = '<option value="">×‘×—×¨ ×œ×§×•×—...</option>' + 
                customersData.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            featureSelect.innerHTML = '<option value="">×‘×—×¨ ×¤×™×¦\'×¨...</option>' + 
                featuresData.features.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        }
        
        // Add feature
        function addFeature() {
            const name = document.getElementById('feature-name').value.trim();
            if (!name) return alert('× × ×œ×”×–×™×Ÿ ×©× ×¤×™×¦\'×¨');
            
            const feature = {
                id: 'f_' + Date.now(),
                name,
                description: document.getElementById('feature-description').value.trim(),
                status: document.getElementById('feature-status').value,
                category: document.getElementById('feature-category').value,
                createdAt: new Date().toISOString()
            };
            
            featuresData.features.push(feature);
            document.getElementById('feature-name').value = '';
            document.getElementById('feature-description').value = '';
            renderAll();
            saveData('features.json', featuresData);
        }
        
        // Delete feature
        function deleteFeature(id) {
            if (!confirm('×œ××—×•×§ ××ª ×”×¤×™×¦\'×¨?')) return;
            featuresData.features = featuresData.features.filter(f => f.id !== id);
            requestsData.requests = requestsData.requests.filter(r => r.featureId !== id);
            renderAll();
            saveData('features.json', featuresData);
            saveData('requests.json', requestsData);
        }
        
        // Add manual customer
        function addManualCustomer() {
            const name = document.getElementById('manual-customer-name').value.trim();
            if (!name) return alert('× × ×œ×”×–×™×Ÿ ×©× ×œ×§×•×—');
            
            const customer = {
                id: 'c_' + Date.now(),
                name,
                source: 'manual'
            };
            
            customersData.customers.push(customer);
            document.getElementById('manual-customer-name').value = '';
            renderAll();
            saveData('customers.json', customersData);
        }
        
        // Delete customer
        function deleteCustomer(id) {
            if (!confirm('×œ××—×•×§ ××ª ×”×œ×§×•×—?')) return;
            customersData.customers = customersData.customers.filter(c => c.id !== id);
            requestsData.requests = requestsData.requests.filter(r => r.customerId !== id);
            renderAll();
            saveData('customers.json', customersData);
            saveData('requests.json', requestsData);
        }
        
        // Powerlink API config
        const POWERLINK_TOKEN = 'd7e7dda4-c054-4545-b951-1a3d5a393c07';
        const POWERLINK_API_URL = 'https://api.powerlink.co.il/api/query';
        const CORS_PROXY = 'https://corsproxy.io/?url=';

        // Fetch a single page of customers from Powerlink
        async function fetchCustomerPage(pageNumber) {
            const response = await fetch(CORS_PROXY + encodeURIComponent(POWERLINK_API_URL), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'tokenid': POWERLINK_TOKEN
                },
                body: JSON.stringify({
                    objecttype: 1,
                    page_size: 500,
                    page_number: pageNumber,
                    fields: 'accountid,accountname,telephone1,emailaddress1,accountnumber',
                    query: '',
                    sort_by: 'accountname',
                    sort_type: 'asc'
                })
            });

            if (!response.ok) throw new Error('API Error: ' + response.status);
            return await response.json();
        }

        // Sync all customers from Powerlink with pagination
        async function syncCustomers() {
            const btn = document.getElementById('sync-btn');
            const statusEl = document.getElementById('sync-status');
            btn.disabled = true;
            btn.textContent = 'â³ ××¡× ×›×¨×Ÿ...';
            statusEl.textContent = '××ª×—×™×œ ×¡× ×›×¨×•×Ÿ...';

            try {
                let allRecords = [];
                let pageNumber = 1;
                let isLastPage = false;

                while (!isLastPage) {
                    statusEl.textContent = `×˜×•×¢×Ÿ ×¢××•×“ ${pageNumber}...`;
                    const result = await fetchCustomerPage(pageNumber);

                    if (!result.success) throw new Error(result.message || '×©×’×™××” ×‘×ª×©×•×‘×ª ×”-API');

                    const records = result.data.Data || [];
                    allRecords = allRecords.concat(records);
                    isLastPage = result.data.IsLastPage;
                    pageNumber++;
                }

                statusEl.textContent = `×¢×™×‘×•×“ ${allRecords.length} ×œ×§×•×—×•×ª...`;

                // Update customers data
                allRecords.forEach(acc => {
                    const plId = acc.accountid;
                    const existingIndex = customersData.customers.findIndex(
                        c => c.powerlinkId === plId
                    );

                    const customer = {
                        id: existingIndex >= 0 ? customersData.customers[existingIndex].id : 'c_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                        powerlinkId: plId,
                        name: acc.accountname || '×œ×œ× ×©×',
                        phone: acc.telephone1 || '',
                        email: acc.emailaddress1 || '',
                        accountNumber: acc.accountnumber || '',
                        source: 'powerlink'
                    };

                    if (existingIndex >= 0) {
                        customersData.customers[existingIndex] = customer;
                    } else {
                        customersData.customers.push(customer);
                    }
                });

                customersData.lastSync = new Date().toISOString();
                renderAll();
                saveData('customers.json', customersData);
                statusEl.textContent = `×¡× ×›×¨×•×Ÿ ×”×•×©×œ× - ${allRecords.length} ×œ×§×•×—×•×ª × ×˜×¢× ×•`;
                alert(`×¡× ×›×¨×•×Ÿ ×”×•×©×œ×! ${allRecords.length} ×œ×§×•×—×•×ª × ×˜×¢× ×•.`);

            } catch (error) {
                console.error('Sync error:', error);
                statusEl.textContent = '×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ: ' + error.message;
                alert('×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ ×¡× ×›×¨×•×Ÿ ×-Powerlink';
            }
        }
        
        // Add request
        function addRequest() {
            const customerId = document.getElementById('request-customer').value;
            const featureId = document.getElementById('request-feature').value;
            
            if (!customerId || !featureId) return alert('× × ×œ×‘×—×•×¨ ×œ×§×•×— ×•×¤×™×¦\'×¨');
            
            // Check if already exists
            if (requestsData.requests.some(r => r.customerId === customerId && r.featureId === featureId)) {
                return alert('×‘×§×©×” ×–×• ×›×‘×¨ ×§×™×™××ª');
            }
            
            const request = {
                id: 'r_' + Date.now(),
                customerId,
                featureId,
                priority: parseInt(document.getElementById('request-priority').value),
                notes: document.getElementById('request-notes').value.trim(),
                date: new Date().toISOString()
            };
            
            requestsData.requests.push(request);
            document.getElementById('request-notes').value = '';
            renderAll();
            saveData('requests.json', requestsData);
        }
        
        // Delete request
        function deleteRequest(id) {
            if (!confirm('×œ××—×•×§ ××ª ×”×‘×§×©×”?')) return;
            requestsData.requests = requestsData.requests.filter(r => r.id !== id);
            renderAll();
            saveData('requests.json', requestsData);
        }
        
        // Assign modal
        function openAssignModal(featureId) {
            currentAssignFeatureId = featureId;
            const feature = featuresData.features.find(f => f.id === featureId);
            document.getElementById('assign-feature-name').textContent = `×¤×™×¦'×¨: ${feature.name}`;
            
            const assignedCustomerIds = requestsData.requests
                .filter(r => r.featureId === featureId)
                .map(r => r.customerId);
            
            document.getElementById('customers-checkbox-list').innerHTML = 
                customersData.customers.map(c => `
                    <label class="checkbox-item">
                        <input type="checkbox" value="${c.id}" ${assignedCustomerIds.includes(c.id) ? 'checked' : ''}>
                        ${c.name}
                    </label>
                `).join('');
            
            document.getElementById('assign-modal').classList.add('active');
        }
        
        function closeAssignModal() {
            document.getElementById('assign-modal').classList.remove('active');
            currentAssignFeatureId = null;
        }
        
        function saveAssignments() {
            const checkboxes = document.querySelectorAll('#customers-checkbox-list input[type="checkbox"]');
            const selectedCustomerIds = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            // Remove existing requests for this feature
            requestsData.requests = requestsData.requests.filter(r => r.featureId !== currentAssignFeatureId);
            
            // Add new requests
            selectedCustomerIds.forEach(customerId => {
                requestsData.requests.push({
                    id: 'r_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    customerId,
                    featureId: currentAssignFeatureId,
                    priority: 3,
                    notes: '',
                    date: new Date().toISOString()
                });
            });
            
            closeAssignModal();
            renderAll();
            saveData('requests.json', requestsData);
        }
        
        // Init - check session
        if (sessionStorage.getItem('loggedInUser')) {
            showApp();
        }
    </script>
</body>
</html>
